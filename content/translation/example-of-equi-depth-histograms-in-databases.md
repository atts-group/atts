---
title: "Example of Equi Depth Histograms in Databases"
date: 2019-04-14T23:05:56+08:00
draft: false
---

原文链接：https://stackoverflow.com/a/14284218



警告：我不是一个数据库底层的专家，所以这只是一个简单泛泛的回答。

查询编译器会将查询（一般以 sql 的形式）转换成一个查询计划并得到查询结果。查询计划里面包含数据库引擎的低层次指令，比如扫描表 T 在 C 列查询 V 值；在 T 表使用索引 X 来定位 V 等等。

查询优化是指编译器要在一些列查询计划中判断出哪个代价最小。代价包括始终时间，IO 单宽，存储空间，cpu 等等。从概念上讲，查询编译器是从一组计划空间中衡量每一种计划的代价，选择它能找到的最小代价的。

上面提到的这些取决于读写的数据条数，数据是否能够被索引定位到，哪些列会被被使用，数据尺寸，以及多少磁盘空间会被占用。

这些数据很多时候取决于表中到底存了多少数据。比如这样一个查询：`select * from data where pay > 100` ，其中 `pay` 被索引。如果 pay 列没有大于 100 的值，那么这个查询代价会很小。使用索引扫描就行了。相反的，结果可能包含了整张表。

这块儿，直方图会起作用（等高直方图只是直方图的其中一种）。在前面的查询中，直方图可以在 O(1) 时间复杂度里对查询匹配的数据行数进行一个评估，在不需要了解数据库里到底有哪些数据的情况下。

实际上，编译器是在数据的摘要之上"执行"了查询。直方图就是这个摘要。直方图在评估代价和查询算子的结果大小上很有用，比如：表连接结果大小，插入和删除时被影响到的页数等。

以一个简单的内连接为例，假如我们知道用来连接两张表的列的数据分布：

```
Bins (25% each)
Table A                    Table B
0-100                      151-300 
101-150                    301-500  
151-175                    601-700
176-300                    1001-1100
```

可以很容易看到 A 表中 50% 的数据和 B 表中 25% 的数据会参与到查询当中。如果有唯一列的话，我们可以评估连接的结果大小应该是 max(.5 * |A|, .25 * |B|)。这是很简单的一个列子。在很多的场景中，统计分析需要更复杂一些的数学知识。对于连接来说，经常通过算子的直方图技术连接的评估直方图。